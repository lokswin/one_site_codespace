DO $$
DECLARE
    v_connection_id INT;
    v_entity_id INT;
BEGIN
    -- Insert a new connection and retrieve its ID
    INSERT INTO guacamole_connection (connection_name, protocol)
    VALUES ('Firefox VNC Automatic', 'vnc')
    RETURNING connection_id INTO v_connection_id;

    -- Insert connection parameters using the retrieved connection ID
    INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value)
    VALUES
        (v_connection_id, 'hostname', 'firefox_vnc'),
        (v_connection_id, 'port', '5900'),
        (v_connection_id, 'password', 'guacadmin'),
        (v_connection_id, 'username', 'x11vnc'),
        (v_connection_id, 'guacd-hostname', 'guacd'),
        (v_connection_id, 'guacd-port', '4822'),
        (v_connection_id, 'encryption', 'none');

    -- Retrieve the entity_id for the 'guacadmin' user
    SELECT entity_id INTO v_entity_id
    FROM guacamole_entity
    WHERE name = 'guacadmin' AND type = 'USER';

    -- Grant read permission to the 'guacadmin' user for the new connection
    INSERT INTO guacamole_connection_permission (entity_id, connection_id, permission)
    VALUES (v_entity_id, v_connection_id, 'READ');
END $$;
