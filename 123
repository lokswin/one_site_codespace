# network_validation.py

import subprocess
import logging
import os  # Ensure 'os' is imported
import re  # Ensure 're' is imported

VAR_PATTERN = re.compile(r'\$\{([^}:\s]+)(:-([^}]+))?\}')

def evaluate_env_var(var_string):
    """Evaluate environment variable with default value."""
    match = VAR_PATTERN.match(str(var_string))
    if match:
        var_name = match.group(1)
        default_value = match.group(3) or ''
        return os.getenv(var_name, default_value)
    return var_string

def validate_network_connectivity(compose_config):
    """Validate network connectivity between services."""
    logging.info("Validating network connectivity between services...")
    services = compose_config.get('services', {})

    for service_name, config in services.items():
        depends_on = config.get('depends_on', [])

        # Get and evaluate the container name for the service
        service_container_name = config.get('container_name', service_name)
        service_container_name = evaluate_env_var(service_container_name)

        for dependency_name in depends_on:
            # Get and evaluate the container name for the dependency
            dependency_config = services.get(dependency_name, {})
            dependency_container_name = dependency_config.get('container_name', dependency_name)
            dependency_container_name = evaluate_env_var(dependency_container_name)

            try:
                logging.info(f"Checking connectivity from '{service_name}' to '{dependency_name}'...")

                # Use the evaluated container names in 'docker exec'
                response = subprocess.run(
                    ["docker", "exec", service_container_name, "ping", "-c", "3", dependency_name],
                    capture_output=True, text=True
                )
                if response.returncode == 0:
                    logging.info(f"[OK] '{service_name}' can reach '{dependency_name}'.")
                else:
                    logging.warning(f"[FAIL] '{service_name}' cannot reach '{dependency_name}': {response.stderr.strip()}")
            except Exception as e:
                logging.error(f"[ERROR] Connectivity check failed for '{service_name}': {e}")

    # The rest of your code remains unchanged
